---
phase: 04-zwicker-integration
plan: 02
type: execute
domain: cli
---

<objective>
Add CLI support for psychoacoustic metrics: --no-psychoacoustic flag and human-readable interpretation.

Purpose: Give users control over slow psychoacoustic computation and provide interpretive context for metrics.
Output: Updated CLI with flag, updated interpret.py with psychoacoustic interpretation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-zwicker-integration/04-RESEARCH.md

**Prior plan context:**
04-01-PLAN.md added psychoacoustic.py module and integrated into analyze()

**Key files:**
@src/audioloop/cli.py
@src/audioloop/interpret.py
@src/audioloop/analyze.py

**From RESEARCH.md:**
- MoSQITo is slow (50+ seconds for 30s audio)
- Need --no-psychoacoustic flag for quick analysis
- Distinct units: sones (loudness), acum (sharpness), asper (roughness)
- Zwicker loudness (sones) is different from LUFS - must label clearly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --no-psychoacoustic flag to analyze CLI command</name>
  <files>src/audioloop/cli.py, src/audioloop/analyze.py</files>
  <action>
1. Modify analyze() function signature in analyze.py to accept optional skip parameter:
   ```python
   def analyze(path: Path, skip_psychoacoustic: bool = False) -> AnalysisResult:
   ```

2. In analyze() function body, conditionally compute psychoacoustic:
   ```python
   if skip_psychoacoustic:
       psychoacoustic = {}
   else:
       psychoacoustic = compute_psychoacoustic(y, sr) or {}
   ```

3. Add flag to CLI analyze command in cli.py:
   ```python
   @app.command()
   def analyze(
       file: Path = typer.Argument(...),
       json_output: bool = typer.Option(False, "--json", "-j", help="Output as JSON"),
       no_psychoacoustic: bool = typer.Option(
           False,
           "--no-psychoacoustic",
           help="Skip psychoacoustic metrics (faster analysis)",
       ),
   ) -> None:
   ```

4. Pass flag to analyze function:
   ```python
   result = do_analyze(file, skip_psychoacoustic=no_psychoacoustic)
   ```

**What to avoid and WHY:**
- Don't use --skip-psychoacoustic (double negative with "no" prefix is clearer)
- Don't change default behavior - psychoacoustic should run by default when available
- Don't add flag to compare command yet - keep scope focused
  </action>
  <verify>
audioloop analyze --help | grep -i psychoacoustic
audioloop analyze tests/fixtures/test_tone.wav --no-psychoacoustic --json | python -c "import sys,json; d=json.load(sys.stdin); print(d.get('psychoacoustic', {}))"
  </verify>
  <done>
- analyze() accepts skip_psychoacoustic parameter
- CLI has --no-psychoacoustic flag
- Flag skips psychoacoustic computation when set
- Default behavior unchanged (psychoacoustic runs if available)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add psychoacoustic interpretation to human-readable output</name>
  <files>src/audioloop/interpret.py, tests/test_analyze_cli.py</files>
  <action>
1. Add interpretation functions to interpret.py:

   ```python
   def interpret_zwicker_loudness(sones: float) -> str:
       """Add reference context to Zwicker loudness value.

       Note: Sones are relative (uncalibrated). Values indicate
       perceived loudness relative to reference, not absolute SPL.
       """
       if sones < 5:
           desc = "quiet"
       elif sones < 20:
           desc = "moderate"
       elif sones < 50:
           desc = "loud"
       else:
           desc = "very loud"
       return f"{sones:.1f} sone ({desc})"

   def interpret_sharpness(acum: float) -> str:
       """Add reference context to sharpness value.

       Acum scale: 1.0 = reference narrow-band noise at 1kHz.
       Higher = more high-frequency energy perceived.
       """
       if acum < 1.0:
           desc = "dull/warm"
       elif acum < 2.0:
           desc = "neutral"
       elif acum < 3.0:
           desc = "bright"
       else:
           desc = "harsh/piercing"
       return f"{acum:.2f} acum ({desc})"

   def interpret_roughness(asper: float) -> str:
       """Add reference context to roughness value.

       Asper scale: Perception of rapid amplitude modulation (20-300 Hz).
       0 = smooth, higher = more textured/gritty.
       """
       if asper < 0.1:
           desc = "smooth"
       elif asper < 0.5:
           desc = "slight texture"
       elif asper < 1.0:
           desc = "noticeable modulation"
       else:
           desc = "rough/gritty"
       return f"{asper:.3f} asper ({desc})"
   ```

2. Update format_analysis_human() to include PSYCHOACOUSTIC section:

   After the LOUDNESS section, add:
   ```python
   # PSYCHOACOUSTIC section (if data available)
   if result.psychoacoustic:
       psych_table = Table(title="PSYCHOACOUSTIC", show_header=False, box=None)
       psych_table.add_column("Feature", style="dim")
       psych_table.add_column("Value")

       if "loudness_sone" in result.psychoacoustic:
           psych_table.add_row(
               "Zwicker Loudness",
               interpret_zwicker_loudness(result.psychoacoustic["loudness_sone"])
           )
       if "sharpness_acum" in result.psychoacoustic:
           psych_table.add_row(
               "Sharpness",
               interpret_sharpness(result.psychoacoustic["sharpness_acum"])
           )
       if "roughness_asper" in result.psychoacoustic:
           psych_table.add_row(
               "Roughness",
               interpret_roughness(result.psychoacoustic["roughness_asper"])
           )

       console.print()
       console.print(psych_table)
   ```

3. Add test for interpretation output (in test_analyze_cli.py or new test file)

**What to avoid and WHY:**
- Don't confuse Zwicker loudness (sones) with LUFS - label "Zwicker Loudness" explicitly
- Don't crash if psychoacoustic dict is empty - check before accessing keys
- Don't add psychoacoustic to table if not computed (--no-psychoacoustic used)
  </action>
  <verify>
pip install -e ".[psychoacoustic]" && audioloop analyze tests/fixtures/test_tone.wav 2>&1 | grep -i "PSYCHOACOUSTIC\|sone\|acum\|asper"
pytest tests/test_analyze_cli.py -v -k "human or format" 2>/dev/null || pytest tests/ -v -k "interpret" 2>/dev/null || echo "Run full test suite"
pytest tests/ -v
  </verify>
  <done>
- interpret.py has interpret_zwicker_loudness(), interpret_sharpness(), interpret_roughness()
- format_analysis_human() includes PSYCHOACOUSTIC section when data present
- Human-readable output shows Zwicker Loudness, Sharpness, Roughness with context
- Section omitted gracefully when psychoacoustic dict is empty
- All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `audioloop analyze --help` shows --no-psychoacoustic flag
- [ ] `audioloop analyze file.wav --no-psychoacoustic` skips psychoacoustic
- [ ] `audioloop analyze file.wav` (default) includes psychoacoustic section
- [ ] Human output shows "PSYCHOACOUSTIC" section with interpreted values
- [ ] `pytest tests/ -v` passes all tests
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- CLI has --no-psychoacoustic flag
- Human-readable output includes interpreted psychoacoustic metrics
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-zwicker-integration/04-02-SUMMARY.md`

Final verification:
- [ ] Both 04-01 and 04-02 summaries exist
- [ ] All tests pass
- [ ] JSON output has psychoacoustic section
- [ ] Human output has PSYCHOACOUSTIC table with interpretations
</output>

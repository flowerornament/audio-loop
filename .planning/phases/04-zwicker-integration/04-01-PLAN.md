---
phase: 04-zwicker-integration
plan: 01
type: execute
domain: audio-analysis
---

<objective>
Add psychoacoustic metrics (Zwicker loudness, sharpness, roughness) to the analysis pipeline.

Purpose: Enable Claude to reason about perceptual qualities of sound, not just signal properties.
Output: New psychoacoustic.py module integrated into analyze() output.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-zwicker-integration/04-RESEARCH.md

**Key files:**
@src/audioloop/analyze.py
@src/audioloop/errors.py
@pyproject.toml

**Prior phase context:**
@.planning/phases/02-analysis-core/02-01-SUMMARY.md

**Tech stack available:**
- librosa (for resampling to 48kHz)
- pyloudnorm (already has LUFS - complementary)
- soundfile, numpy, scipy

**From RESEARCH.md:**
- MoSQITo requires 48kHz mono audio - preprocess all inputs
- Fluctuation strength NOT implemented - skip it
- Use direct function API (loudness_zwtv, sharpness_din_from_loudness, roughness_dw)
- Graceful fallback if MoSQITo not installed
- Use calib=1.0 (relative values, not calibrated SPL)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create psychoacoustic.py module with MoSQITo wrapper</name>
  <files>src/audioloop/psychoacoustic.py, pyproject.toml</files>
  <action>
Create new module src/audioloop/psychoacoustic.py with:

1. `prepare_for_mosqito(y: np.ndarray, sr: int) -> tuple[np.ndarray, int]`
   - Resample to 48kHz using librosa.resample if needed
   - Convert to mono by averaging channels if stereo
   - Cast to float32 for MoSQITo
   - Return (processed_signal, 48000)

2. `compute_psychoacoustic(y: np.ndarray, sr: int) -> dict | None`
   - Lazy import MoSQITo at function call time (not module level)
   - Return None if ImportError (MoSQITo not installed)
   - Call prepare_for_mosqito() first
   - Compute:
     - loudness_zwtv() → extract mean and max from N array
     - sharpness_din_from_loudness() → extract mean from S array
     - roughness_dw() → extract mean from R array
   - Return dict:
     ```python
     {
         "loudness_sone": float(np.mean(N)),
         "loudness_sone_max": float(np.max(N)),
         "sharpness_acum": float(np.mean(S)),
         "roughness_asper": float(np.mean(R)),
     }
     ```
   - Wrap in try/except for MoSQITo errors (edge cases with short/silent audio)

3. Add mosqito>=1.2.0 to [project.optional-dependencies] in pyproject.toml:
   ```toml
   [project.optional-dependencies]
   psychoacoustic = ["mosqito>=1.2.0"]
   dev = [...]
   ```

**What to avoid and WHY:**
- Don't import MoSQITo at module level - it's an optional dependency
- Don't process stereo directly - MoSQITo expects mono
- Don't skip the 48kHz resample - MoSQITo silently gives wrong values otherwise
- Don't use Audio class - direct function API is simpler
  </action>
  <verify>
python -c "from audioloop.psychoacoustic import compute_psychoacoustic; print('Import OK')"
pip install -e ".[psychoacoustic]" && python -c "from mosqito.sq_metrics import loudness_zwtv; print('MoSQITo OK')"
  </verify>
  <done>
- psychoacoustic.py exists with compute_psychoacoustic() function
- Returns dict with loudness_sone, loudness_sone_max, sharpness_acum, roughness_asper
- Returns None gracefully if MoSQITo not installed
- pyproject.toml has [psychoacoustic] optional dependency
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate psychoacoustic section into AnalysisResult</name>
  <files>src/audioloop/analyze.py, tests/test_analyze.py</files>
  <action>
Modify analyze.py to include psychoacoustic metrics:

1. Add import at top (after other imports):
   ```python
   from audioloop.psychoacoustic import compute_psychoacoustic
   ```

2. Add psychoacoustic field to AnalysisResult dataclass:
   ```python
   psychoacoustic: dict = field(default_factory=dict)  # NEW - empty if MoSQITo unavailable
   ```

3. Update to_dict() method to include psychoacoustic field

4. In analyze() function, after loading audio and computing other features:
   ```python
   # Compute psychoacoustic metrics (if MoSQITo available)
   # Use original signal before channel extraction for best quality
   psychoacoustic = compute_psychoacoustic(y, sr) or {}
   ```

5. Pass psychoacoustic to AnalysisResult constructor

6. Add test in test_analyze.py verifying:
   - analyze() returns AnalysisResult with psychoacoustic field
   - psychoacoustic is dict (may be empty if no MoSQITo)
   - If MoSQITo installed, dict has expected keys

**What to avoid and WHY:**
- Don't make psychoacoustic computation block if MoSQITo missing - return empty dict
- Don't fail analyze() if MoSQITo has errors - log warning, continue with empty dict
- Don't modify existing test assertions unless they explicitly check for absence of psychoacoustic
  </action>
  <verify>
pytest tests/test_analyze.py -v
audioloop analyze tests/fixtures/test_tone.wav --json | python -c "import sys,json; d=json.load(sys.stdin); print('psychoacoustic' in d)"
  </verify>
  <done>
- AnalysisResult has psychoacoustic field in dataclass
- to_dict() includes psychoacoustic in output
- analyze() calls compute_psychoacoustic() and includes result
- JSON output includes "psychoacoustic" key (empty dict if no MoSQITo, populated if installed)
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -e ".[psychoacoustic]"` succeeds
- [ ] `pytest tests/test_analyze.py -v` passes
- [ ] `audioloop analyze tests/fixtures/test_tone.wav --json` includes psychoacoustic section
- [ ] Without MoSQITo: psychoacoustic is empty dict, no crash
- [ ] With MoSQITo: psychoacoustic has loudness_sone, sharpness_acum, roughness_asper
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Psychoacoustic metrics integrated into analyze output
- Graceful fallback when MoSQITo not installed
</success_criteria>

<output>
After completion, create `.planning/phases/04-zwicker-integration/04-01-SUMMARY.md`
</output>

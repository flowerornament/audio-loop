---
phase: 06-spectrogram-visualization
plan: 01
type: execute
---

<objective>
Add spectrogram visualization to audioloop - PNG output with stacked waveform/spectrogram/chroma subplots, plus ASCII energy bands in terminal output.

Purpose: Give Claude visual feedback about audio - spectrograms show harmonic structure, transients, and frequency evolution that numeric features can miss.
Output: New `--spectrogram` flag on analyze/iterate commands, ASCII frequency bands in human output.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/05-performance-optimization/05-01-SUMMARY.md
@.planning/phases/5.1-cli-iterate-command/5.1-01-SUMMARY.md
@.planning/phases/5.2-cli-ux-polish/5.2-01-SUMMARY.md

# Key source files
@src/audioloop/analyze.py
@src/audioloop/cli.py
@src/audioloop/interpret.py
@src/audioloop/layout.py

**Tech stack available:** librosa, matplotlib, numpy (already in project via librosa)
**Established patterns:**
- layout.py for shared styling (num(), section(), row())
- analyze.py returns AnalysisResult dataclass
- cli.py uses typer with --json flag pattern

**Discovery notes (Level 1 - Context7 verification):**
- librosa.display.specshow() for STFT/Mel/Chroma visualization
- librosa.display.waveshow() for waveform
- Multi-subplot with sharex=True for synchronized display
- librosa.power_to_db() for dB scaling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spectrogram generation module</name>
  <files>src/audioloop/spectrogram.py</files>
  <action>
Create new module that generates a stacked visualization PNG:

1. Function `generate_spectrogram(audio_path: Path, output_path: Path, sr: int = None) -> Path`
2. Three stacked subplots with shared x-axis:
   - Top: Waveform (librosa.display.waveshow)
   - Middle: Mel spectrogram (librosa.display.specshow with y_axis='mel')
   - Bottom: Chromagram (librosa.display.specshow with y_axis='chroma')
3. Use consistent figure sizing (figsize=(12, 8))
4. Add colorbar for spectrogram (dB scale)
5. Add time labels on bottom subplot only (label_outer pattern)
6. Save as PNG with tight_layout

Use existing librosa load pattern from analyze.py. Convert to mono for visualization.
Do NOT add matplotlib to requirements - it's already a librosa dependency.
  </action>
  <verify>
```bash
# Create test script
python -c "
from pathlib import Path
from audioloop.spectrogram import generate_spectrogram
# Use test fixture
p = generate_spectrogram(Path('tests/fixtures/test_tone.wav'), Path('/tmp/test_spec.png'))
print(f'Generated: {p}')
import os
print(f'Size: {os.path.getsize(p)} bytes')
"
# Should generate PNG > 10KB
```
  </verify>
  <done>generate_spectrogram() creates readable PNG with waveform/spectrogram/chroma stacked</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI integration for spectrogram</name>
  <files>src/audioloop/cli.py, src/audioloop/analyze.py</files>
  <action>
Add `--spectrogram` / `-s` option to `analyze` and `iterate` commands:

1. In cli.py analyze command:
   - Add `spectrogram: Optional[Path] = typer.Option(None, "--spectrogram", "-s", help="Save spectrogram PNG to path")`
   - After analysis, if spectrogram path provided, call generate_spectrogram()
   - Print confirmation in human mode, include path in JSON output

2. In cli.py iterate command:
   - Same pattern - add --spectrogram option
   - Generate spectrogram before cleanup of temp wav (if not --keep)

3. JSON output format when spectrogram generated:
   ```json
   {
     "analysis": {...},
     "spectrogram_path": "/path/to/spectrogram.png"
   }
   ```

4. Human output: Print "Spectrogram: /path/to/file.png" after analysis
  </action>
  <verify>
```bash
# Test analyze with spectrogram
audioloop analyze tests/fixtures/test_tone.wav --spectrogram /tmp/analyze_spec.png
ls -la /tmp/analyze_spec.png

# Test iterate with spectrogram
audioloop iterate --code -d 1 "{ SinOsc.ar(440) * 0.3 ! 2 }" --no-play --spectrogram /tmp/iter_spec.png
ls -la /tmp/iter_spec.png
```
  </verify>
  <done>--spectrogram flag works on analyze and iterate, generates PNG at specified path</done>
</task>

<task type="auto">
  <name>Task 3: Add ASCII energy bands to human output</name>
  <files>src/audioloop/interpret.py, src/audioloop/analyze.py</files>
  <action>
Add ASCII frequency band visualization to human-readable output:

1. In analyze.py, add function to compute band energies:
   ```python
   def compute_band_energies(y: np.ndarray, sr: int) -> dict:
       """Compute energy in frequency bands: sub/bass/low-mid/mid/high-mid/high"""
       # Use STFT, then sum energy in bands:
       # Sub: 20-60 Hz, Bass: 60-250 Hz, Low-mid: 250-500 Hz
       # Mid: 500-2k Hz, High-mid: 2k-4k Hz, High: 4k-20k Hz
   ```

2. Add band_energies to AnalysisResult (optional field, empty dict by default)

3. In interpret.py, add ASCII bar visualization:
   ```
   ─── Frequency Bands ────────────────────────────────
     Sub (20-60)      ███░░░░░░░  0.12
     Bass (60-250)    ██████░░░░  0.45
     Low-mid          ████████░░  0.68
     ...
   ```

   Use layout.py patterns. Bars should be 10 chars wide, filled based on relative energy.
   Normalize to max band = 1.0

4. Show bands section in human output (after Spectral section)
5. Include in JSON as band_energies dict
  </action>
  <verify>
```bash
# Check human output shows bands
audioloop analyze tests/fixtures/test_tone.wav 2>&1 | grep -A7 "Frequency Bands"

# Check JSON includes bands
audioloop analyze tests/fixtures/test_tone.wav --json | python -c "import json,sys; d=json.load(sys.stdin); print('band_energies' in d)"
```
  </verify>
  <done>Human output shows ASCII frequency bands, JSON includes band_energies dict</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `audioloop analyze file.wav --spectrogram out.png` generates readable PNG
- [ ] `audioloop iterate --code -d 1 "{ ... }" --spectrogram out.png` works
- [ ] Human output shows frequency bands visualization
- [ ] JSON output includes spectrogram_path (when used) and band_energies
- [ ] All existing tests still pass: `pytest tests/`
- [ ] PNG is readable by Claude (multimodal check - reasonable size < 500KB)
</verification>

<success_criteria>

- All tasks completed
- Spectrogram PNG shows waveform/spectrogram/chroma stacked
- ASCII energy bands appear in terminal
- Both features integrated into CLI
- No new test failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-spectrogram-visualization/06-01-SUMMARY.md`
</output>

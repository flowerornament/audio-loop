---
phase: 08-mcp-server
plan: 02
type: execute
---

<objective>
Implement all 5 MCP tools wrapping the audioloop CLI commands.

Purpose: Expose render, analyze, iterate, compare, and play functionality through MCP tools with proper schemas.
Output: Fully functional MCP tools that Claude can use to drive audioloop.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-mcp-server/08-RESEARCH.md
@.planning/phases/08-mcp-server/08-01-SUMMARY.md
@src/audioloop/mcp_server.py
@src/audioloop/mcp_models.py
@src/audioloop/cli.py

**From 08-01:** Pydantic models, async run_cli() wrapper, FastMCP server skeleton
**From research:** Image class for spectrogram PNG, separate tools per command, sensible defaults
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement render, analyze, and play tools</name>
  <files>src/audioloop/mcp_server.py</files>
  <action>
Add three tools to the MCP server:

1. `render` tool:
   - Parameters: file_path (str), duration (float | None), output (str | None)
   - Calls: `audioloop render {file_path} --json [--duration D] [-o output]`
   - Returns: RenderResult model
   - Include docstring explaining both NRT and simple function modes

2. `analyze` tool:
   - Parameters: file_path (str), no_psychoacoustic (bool = False), spectrogram_path (str | None = None)
   - Calls: `audioloop analyze {file_path} --json [--no-psychoacoustic] [--spectrogram path]`
   - Returns: AnalysisResult model (or tuple with Image if spectrogram requested)
   - If spectrogram_path provided, read the PNG and return Image alongside result

3. `play` tool:
   - Parameters: file_path (str)
   - Calls: `audioloop play {file_path}` (no JSON output - just success/fail)
   - Returns: dict with success status
   - Note in docstring this blocks until playback completes

For Image handling with spectrogram:
```python
from mcp.server.fastmcp import Image
from pathlib import Path

# After CLI generates spectrogram:
if spectrogram_path:
    img_data = Path(spectrogram_path).read_bytes()
    return (analysis_result, Image(data=img_data, format="png"))
```

Parse JSON output from CLI and construct Pydantic models. Handle errors by raising RuntimeError with stderr content.

Use absolute paths - resolve with Path().resolve() before passing to CLI.
  </action>
  <verify>python -c "from audioloop.mcp_server import mcp; tools = [t.name for t in mcp._tool_manager._tools.values()]; assert 'render' in tools and 'analyze' in tools and 'play' in tools, f'Missing tools: {tools}'"</verify>
  <done>render, analyze, and play tools defined and importable</done>
</task>

<task type="auto">
  <name>Task 2: Implement iterate and compare tools</name>
  <files>src/audioloop/mcp_server.py</files>
  <action>
Add two more tools:

1. `iterate` tool (most important for Claude's workflow):
   - Parameters:
     - source (str): file path OR inline SC code
     - code (bool = False): if True, source is inline SC code
     - duration (float | None): required for inline code or simple functions
     - keep (bool = False): keep WAV file after iterate
     - no_play (bool = False): skip playback
     - no_psychoacoustic (bool = False): skip psychoacoustic metrics
     - spectrogram_path (str | None): save spectrogram PNG
   - Calls: `audioloop iterate {source} --json [flags]`
   - Returns: IterateResult model (or tuple with Image if spectrogram)
   - Docstring should explain this is the primary workflow command

2. `compare` tool:
   - Parameters: file_a (str), file_b (str)
   - Calls: `audioloop compare {file_a} {file_b} --json`
   - Returns: ComparisonResult model
   - Docstring explains delta analysis for A/B comparison

Both tools:
- Parse JSON output and construct models
- Handle spectrogram Image return for iterate
- Use absolute paths
- Include helpful error messages that Claude can use to fix issues
  </action>
  <verify>python -c "from audioloop.mcp_server import mcp; tools = [t.name for t in mcp._tool_manager._tools.values()]; assert 'iterate' in tools and 'compare' in tools, f'Missing: {tools}'"</verify>
  <done>All 5 tools (render, analyze, play, iterate, compare) implemented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 5 tools importable from mcp_server
- [ ] Each tool has proper type hints and docstrings
- [ ] JSON parsing from CLI output works (check manually if possible)
- [ ] Image handling for spectrogram is wired up
</verification>

<success_criteria>

- All 5 CLI commands wrapped as MCP tools
- Tools use Pydantic models for structured responses
- Spectrogram returns Image content
- Error handling includes stderr for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-server/08-02-SUMMARY.md`
</output>

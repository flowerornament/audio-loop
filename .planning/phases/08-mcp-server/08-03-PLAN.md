---
phase: 08-mcp-server
plan: 03
type: execute
---

<objective>
Add tests, verify server works end-to-end, and document configuration.

Purpose: Ensure MCP server is reliable and document how to configure Claude Code to use it.
Output: Test coverage for MCP tools and working configuration instructions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-mcp-server/08-RESEARCH.md
@.planning/phases/08-mcp-server/08-01-SUMMARY.md
@.planning/phases/08-mcp-server/08-02-SUMMARY.md
@src/audioloop/mcp_server.py
@tests/fixtures/test_tone.wav

**From 08-01:** Dependencies including pytest-anyio
**From 08-02:** All 5 tools implemented
**From research:** In-memory transport for testing, MCP inspector for debugging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP server tests with in-memory transport</name>
  <files>tests/test_mcp_server.py</files>
  <action>
Create tests for the MCP server using in-memory transport (no actual stdio):

```python
import pytest
from mcp.client.session import ClientSession
from mcp.shared.memory import create_connected_server_and_client_session

from audioloop.mcp_server import mcp

@pytest.fixture
async def client_session():
    async with create_connected_server_and_client_session(
        mcp._mcp_server, raise_exceptions=True
    ) as (server, client):
        yield client

@pytest.mark.anyio
async def test_analyze_tool(client_session):
    result = await client_session.call_tool(
        "analyze",
        {"file_path": "tests/fixtures/test_tone.wav"}
    )
    # Verify structured content
    ...
```

Tests to include:
1. test_analyze_tool - analyze test fixture WAV, verify spectral fields present
2. test_render_tool - render a simple SC function (may require SC installed)
3. test_iterate_tool - iterate with inline code (may require SC)
4. test_compare_tool - compare test fixture with itself (should show no delta)
5. test_play_tool - call play on test fixture (will actually play audio - consider skip marker)

Use pytest.mark.skipif for tests that require SuperCollider if it's not installed.
Use existing tests/fixtures/test_tone.wav for analyze/compare tests.

Add conftest.py entry if needed for anyio backend selection.
  </action>
  <verify>cd /Users/morgan/code/audio-loop && uv run pytest tests/test_mcp_server.py -v --tb=short 2>&1 | head -50</verify>
  <done>MCP server tests pass (at least analyze and compare which don't need SC)</done>
</task>

<task type="auto">
  <name>Task 2: Add __main__.py entry point and update package exports</name>
  <files>src/audioloop/mcp_server.py, src/audioloop/__init__.py</files>
  <action>
Ensure the MCP server can be run as a module:

1. In mcp_server.py, ensure the `if __name__ == "__main__"` block runs mcp.run()

2. Optionally add to __init__.py exports if desired (not required)

3. Create a brief docstring at module level explaining:
   - What this module does
   - How to run: `python -m audioloop.mcp_server`
   - How to add to Claude Code: `claude mcp add audioloop -- python -m audioloop.mcp_server`

Verify: `python -m audioloop.mcp_server --help` or similar should work (behavior depends on FastMCP CLI support)
  </action>
  <verify>python -c "import audioloop.mcp_server; print('Entry point OK')"</verify>
  <done>Module runnable as `python -m audioloop.mcp_server`</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete MCP server wrapping audioloop CLI</what-built>
  <how-to-verify>
    1. Run: `cd /Users/morgan/code/audio-loop && uv run mcp dev src/audioloop/mcp_server.py`
    2. This opens MCP Inspector in browser
    3. In Inspector, verify all 5 tools appear: render, analyze, iterate, compare, play
    4. Try calling `analyze` with file_path: `/Users/morgan/code/audio-loop/tests/fixtures/test_tone.wav`
    5. Confirm structured JSON response with spectral/temporal data
    6. (Optional) Try `iterate` with code=true, source="{ SinOsc.ar(440) * 0.3 ! 2 }", duration=1
  </how-to-verify>
  <resume-signal>Type "approved" if tools work in Inspector, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MCP tests pass
- [ ] Server runs as module
- [ ] MCP Inspector shows all 5 tools
- [ ] At least analyze tool works in Inspector
</verification>

<success_criteria>

- All tasks completed
- Tests pass
- MCP Inspector verification confirms tools work
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-mcp-server/08-03-SUMMARY.md` with:
- Test results
- Inspector verification outcome
- Any issues encountered
- Configuration instructions for Claude Code

Also update ROADMAP.md to mark Phase 8 plans complete.
</output>

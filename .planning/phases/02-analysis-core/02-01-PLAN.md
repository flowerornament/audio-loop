---
phase: 02-analysis-core
plan: 01
type: execute
domain: audio-analysis
---

<objective>
Implement librosa-based audio feature extraction with per-channel spectral analysis and stereo metrics.

Purpose: Create the core analysis engine that extracts acoustic features Claude can reason about.
Output: Analysis module returning structured feature data for any WAV file.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analysis-core/RESEARCH.md

# Prior phase context:
@.planning/phases/01-render-pipeline/01-SUMMARY.md

# Existing source files:
@src/audioloop/cli.py
@src/audioloop/render.py
@pyproject.toml

**Tech stack available:** typer, rich, pytest
**Established patterns:** CLI with typer, subprocess management
**Constraining decisions:**
- Phase 1: JSON output format established for Claude parsing
- Phase 1: Exit codes 0/1/2 for success/SC error/system error

**From RESEARCH.md:**
- Use librosa for spectral/temporal features
- Use pyloudnorm for LUFS measurement
- MoSQITo deferred to Milestone 2 (psychoacoustics)
- Analyze L/R channels separately, compute per-channel features
- No hardcoded interpretation thresholds - provide reference ranges only
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analysis dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add required dependencies for audio analysis:
- librosa>=0.10.0,<0.12 (spectral features, pitch, RMS)
- soundfile>=0.12.0 (audio I/O for librosa)
- pyloudnorm>=0.1.0 (LUFS measurement)
- numpy>=1.24.0 (explicit requirement)
- scipy>=1.10.0 (stereo coherence, signal processing)

Add to [project.dependencies] section alongside existing typer and rich.

Do NOT add MoSQITo, sparklines, or orjson yet - those are for later phases.
  </action>
  <verify>uv sync succeeds and `python -c "import librosa; import soundfile; import pyloudnorm"` passes</verify>
  <done>Dependencies installed, imports work</done>
</task>

<task type="auto">
  <name>Task 2: Create core analysis module</name>
  <files>src/audioloop/analyze.py</files>
  <action>
Create analyze.py with:

1. **AnalysisResult dataclass** with fields matching PROJECT.md schema:
   - file: str
   - duration_sec: float
   - sample_rate: int
   - channels: int
   - spectral: dict with left/right sub-dicts containing:
     - centroid_hz: float
     - rolloff_hz: float
     - flatness: float
     - bandwidth_hz: float
   - temporal: dict with:
     - attack_ms: float
     - rms: float
     - crest_factor: float
   - stereo: dict with:
     - width: float
     - correlation: float
   - loudness_lufs: float

2. **analyze(path: Path) -> AnalysisResult** function:
   - Load audio with librosa (sr=None for native rate)
   - Handle mono (duplicate channel) and stereo
   - For each channel, compute:
     - Spectral centroid (mean over frames)
     - Spectral rolloff (mean)
     - Spectral flatness (mean)
     - Spectral bandwidth (mean)
   - For combined signal:
     - RMS (overall)
     - Crest factor (peak / RMS)
     - Attack time (time to reach 90% of peak)
   - For stereo:
     - Width (side_energy / (mid_energy + side_energy))
     - Correlation (np.corrcoef(left, right)[0,1])
   - LUFS via pyloudnorm

Use mean aggregation across frames for spectral features. The goal is a single summary value per feature, not time-series data.

Error handling: Raise AnalysisError for invalid files, corrupted audio, etc.
  </action>
  <verify>`python -c "from audioloop.analyze import analyze; from pathlib import Path"` imports successfully</verify>
  <done>analyze() function returns AnalysisResult with all spectral/temporal/stereo features</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for analysis module</name>
  <files>tests/test_analyze.py, tests/fixtures/test_tone.wav</files>
  <action>
Create tests/test_analyze.py with:

1. **Generate a test fixture** (or use existing WAV from Phase 1 tests if available):
   - If no WAV exists, generate a simple 1-second stereo sine wave (440Hz) using scipy and soundfile
   - Save to tests/fixtures/test_tone.wav

2. **Test cases:**
   - test_analyze_returns_result: Basic analysis returns AnalysisResult with all fields
   - test_spectral_features_reasonable: Centroid for 440Hz tone should be near 440Hz (within 50Hz)
   - test_stereo_features: Width near 0 for identical L/R, correlation near 1.0
   - test_rms_nonzero: RMS should be positive for non-silent audio
   - test_duration_correct: Duration matches expected (within 0.1s tolerance)
   - test_mono_handling: Mono files are handled (spectral.left == spectral.right)
   - test_invalid_file_raises: Non-existent file raises AnalysisError

Use pytest. Keep tests fast (test file is ~1 second).
  </action>
  <verify>pytest tests/test_analyze.py -v passes all tests</verify>
  <done>7+ tests passing, covering happy path and edge cases</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv sync` completes without errors
- [ ] `python -c "import librosa; import soundfile; import pyloudnorm; from audioloop.analyze import analyze"` succeeds
- [ ] `pytest tests/test_analyze.py -v` passes all tests
- [ ] Analysis of test WAV returns reasonable values (centroid near expected, RMS > 0)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/Python errors
- analyze() function extracts all features from PROJECT.md schema
- Ready for 02-02-PLAN.md (CLI integration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-core/02-01-SUMMARY.md` following the summary template.
</output>
